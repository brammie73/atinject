<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
</head>
<body>

<script>

// randomUUID
function randomUUID() {
	return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
	    var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
	    return v.toString(16);
	});
};

// cast

var stringConstructor = "".constructor;
var arrayConstructor = [].constructor;
var objectConstructor = {}.constructor;

function cast(rawObj, constructor)
{
    var obj = new constructor();
    for(var i in rawObj){
    	if (rawObj[i] === null){
    		alert(i + " is null");
    		obj[i] = rawObj[i];
    	}
    	else if (rawObj[i] === undefined){
    		alert(i + " is undefined");
    		obj[i] = rawObj[i];
    	}
    	else if (rawObj[i].constructor === stringConstructor){
    		alert(i + " is string");
    		obj[i] = rawObj[i];
    	}
    	else if (rawObj[i].constructor === arrayConstructor){
    		alert(i + " is array");
    		
    		for (var j in rawObj[i]){
    			if (rawObj[i][j] === null){
    				obj[i][j] = rawObj[i][j];
    			}
    			else if (rawObj[i][j] === undefined){
    				obj[i][j] = rawObj[i][j];
    			}
    			else if (rawObj[i][j] === stringConstructor){
    				obj[i][j] = rawObj[i][j];
    			}
    			else if (rawObj[i][j] === arrayConstructor){
    				// TODO extract cast array method to be recursive
    			}
    			else if (rawObj[i][j] === objectConstructor){
    				obj[i][j] = cast(rawObj[i], classAlias[rawObj[i]._class]);
    			}
    		}
    	}
    	else if (rawObj[i].constructor === objectConstructor){
    		alert(i + " is object");
    		obj[i] = cast(rawObj[i], classAlias[rawObj[i]._class]);
    	}
    }
    return obj;
};

// dto
function DTO() {
};

DTO.prototype.getClass = function() {
    return this._class;
}
function BaseWebSocketNotification() {
    this._class = "org.atinject.core.websocket.dto.BaseWebSocketNotification"
};

BaseWebSocketNotification.prototype = new DTO();


function WebSocketResponseException() {
    this._class = "org.atinject.core.websocket.dto.WebSocketResponseException"
};

WebSocketResponseException.prototype = new DTO();


function BaseWebSocketRequest() {
    this._class = "org.atinject.core.websocket.dto.BaseWebSocketRequest"
};

BaseWebSocketRequest.prototype = new DTO();

BaseWebSocketRequest.prototype.getRequestId = function() {
    return this.requestId;
};

BaseWebSocketRequest.prototype.setRequestId = function(requestId) {
    this.requestId = requestId;
    return this;
};


function SessionOpenedNotification() {
    this._class = "org.atinject.api.session.dto.SessionOpenedNotification"
};

SessionOpenedNotification.prototype = new BaseWebSocketNotification();

SessionOpenedNotification.prototype.getSessionId = function() {
    return this.sessionId;
};

SessionOpenedNotification.prototype.setSessionId = function(sessionId) {
    this.sessionId = sessionId;
    return this;
};


function User() {
    this._class = "org.atinject.api.user.dto.User"
};

User.prototype = new DTO();

User.prototype.getId = function() {
    return this.id;
};

User.prototype.setId = function(id) {
    this.id = id;
    return this;
};

User.prototype.getName = function() {
    return this.name;
};

User.prototype.setName = function(name) {
    this.name = name;
    return this;
};

User.prototype.getPassword = function() {
    return this.password;
};

User.prototype.setPassword = function(password) {
    this.password = password;
    return this;
};


function UserAffinityNotification() {
    this._class = "org.atinject.api.user.dto.UserAffinityNotification"
};

UserAffinityNotification.prototype = new BaseWebSocketNotification();

UserAffinityNotification.prototype.getUrl = function() {
    return this.url;
};

UserAffinityNotification.prototype.setUrl = function(url) {
    this.url = url;
    return this;
};


function BaseWebSocketResponse() {
    this._class = "org.atinject.core.websocket.dto.BaseWebSocketResponse"
};

BaseWebSocketResponse.prototype = new DTO();

BaseWebSocketResponse.prototype.getRequestId = function() {
    return this.requestId;
};

BaseWebSocketResponse.prototype.setRequestId = function(requestId) {
    this.requestId = requestId;
    return this;
};

BaseWebSocketResponse.prototype.getException = function() {
    return this.exception;
};

BaseWebSocketResponse.prototype.setException = function(exception) {
    this.exception = exception;
    return this;
};


function GetUserRequest() {
    this._class = "org.atinject.api.user.dto.GetUserRequest"
};

GetUserRequest.prototype = new BaseWebSocketRequest();

GetUserRequest.prototype.getUserId = function() {
    return this.userId;
};

GetUserRequest.prototype.setUserId = function(userId) {
    this.userId = userId;
    return this;
};


function GetUserResponse() {
    this._class = "org.atinject.api.user.dto.GetUserResponse"
};

GetUserResponse.prototype = new BaseWebSocketResponse();

GetUserResponse.prototype.getUser = function() {
    return this.user;
};

GetUserResponse.prototype.setUser = function(user) {
    this.user = user;
    return this;
};


var classAlias = new Array();
classAlias["org.atinject.core.dto.DTO"] = DTO;
classAlias["org.atinject.core.websocket.dto.BaseWebSocketNotification"] = BaseWebSocketNotification;
classAlias["org.atinject.core.websocket.dto.WebSocketResponseException"] = WebSocketResponseException;
classAlias["org.atinject.core.websocket.dto.BaseWebSocketRequest"] = BaseWebSocketRequest;
classAlias["org.atinject.api.session.dto.SessionOpenedNotification"] = SessionOpenedNotification;
classAlias["org.atinject.api.user.dto.User"] = User;
classAlias["org.atinject.api.user.dto.UserAffinityNotification"] = UserAffinityNotification;
classAlias["org.atinject.core.websocket.dto.BaseWebSocketResponse"] = BaseWebSocketResponse;
classAlias["org.atinject.api.user.dto.GetUserRequest"] = GetUserRequest;
classAlias["org.atinject.api.user.dto.GetUserResponse"] = GetUserResponse;

 // web socket service (this will be autogenerated)
function UserWebSocketService(){
	 this.requests = new Object();
};

UserWebSocketService.prototype.doGetUserRequest = function(request){
	var requestId = randomUUID();
	request.setRequestId(requestId);
	this.requests[requestId] = request; 
};
 
UserWebSocketService.prototype.onGetUserResponse = function(response){
    var request = this.requests[response.getRequestId()];
    delete this.requests[response.getRequestId()];
    var event = new CustomEvent("onGetUserRequestResponse", {"detail":{"request":request, "response":response}});
	window.dispatchEvent(event);
};
var userWebSocketService = new UserWebSocketService();
window.addEventListener("onGetUserResponse", function(e){userWebSocketService.onGetUserResponse(e.detail);}, false);

// cache (this will be autogenerated)
function UserCache() {
	this.elements = new Object();
};

UserCache.prototype.getUser = function(userId){
	return this.elements[userId];
};

UserCache.prototype.putUser = function(userId, user){
	this.elements[userId] = user;
};

UserCache.prototype.removeUser = function(userId){
	var user = this.elements[userId];
	delete this.elements[userId];
	return user;
};

UserCache.prototype.clear = function(){
	this.elements = new Object();
};
var userCache = new UserCache();

// real-life usage
// view
function UserView(){
	this.listeners = new Object();
	this.gettingUser = false;
};

UserView.prototype.getUser = function(userId){
	if (this.gettingUser){
		return;
	}
	this.gettingUser = true;
	var listener = function(e){userView.onGetUser(e.detail);}
	var listenerId = "onGetUser_" + userId;
	this.listeners[listenerId] = listener;
	window.addEventListener(listenerId, listener, false);
	userService.getUser(userId);
};

UserView.prototype.onGetUser = function(user){
	var listenerId = "onGetUser_"+user+getUserId();
	var listener = this.listeners[listenerId];
	window.removeEventListener(listenerId, listener, false);
	alert(user.getUserId());
	this.gettingUser = false;
};
var userView = new UserView();

// service
function UserService(){
};

UserService.prototype.getUser = function(userId){
	// look up in cache first
	var user = userCache.getUser(userId);
	if (user != null){
		// found in cache, dispatch
		var event = new CustomEvent("onGetUser_"+userId, {detail:user});
		window.dispatchEvent(event);
	}
	// not in cache, ask server
	var request = new GetUserRequest();
	userWebSocketService.doGetUserRequest(request);
};

UserService.prototype.onGetUser = function(request, response){
	// got response back from server
	if (response.getUser() != null){
		// put object in cache
		userCache.putUser(response.getUser().getId(), response.getUser());
	}
	// dispatch
	var event = new CustomEvent("onGetUser_"+request.getUserId(), {detail:user});
	window.dispatchEvent(event);
};
var userService = new UserService();
window.addEventListener("onGetUserRequestResponse", function(e){userService.onGetUser(e.detail.request, e.detail.response);}, false);


//event test
//1. create request
var doGetUserRequest = new GetUserRequest();
doGetUserRequest.setUserId("123");
userWebSocketService.doGetUserRequest(doGetUserRequest);
//2. simulate response
var onGetUserResponse = new GetUserResponse();
onGetUserResponse.setRequestId(doGetUserRequest.getRequestId());
var onGetUserResponseUser = new User();
onGetUserResponseUser.setId("123");
onGetUserResponse.setUser(onGetUserResponseUser);
//3. dispatch response
var event = new CustomEvent("onGetUserResponse", {detail:onGetUserResponse});
window.dispatchEvent(event);

// test
/*
var getUserResponse = new GetUserResponse();
getUserResponse.setRequestId("abc");
getUserResponse.setException(new WebSocketResponseException());
var getUserResponseString = JSON.stringify(getUserResponse);
alert(getUserResponseString);

var getUserResponseRawObject = JSON.parse(getUserResponseString);
//alert(getUserResponseRawObject.requestId);
var getUserResponseObject = cast(getUserResponseRawObject, classAlias[getUserResponseRawObject._class]);
alert(getUserResponseObject.getRequestId());
alert(getUserResponseObject.getException());
*/
function onWebSocketOpened(event){
	var io = document.getElementById("io");
    io.value = io.value + "Web Socket opened!";
};

function onWebSocketMessage(event){
	var io = document.getElementById("io");
    io.value = io.value + "\n" + event.data
};

function onWebSocketClosed(event){
	var io = document.getElementById('io');
    io.value = io.value + "Web Socket closed";
};

var socket;
function openWebSocket(){
	if (!window.WebSocket) {
	  window.WebSocket = window.MozWebSocket;
	}
	if (window.WebSocket) {
	  socket = new WebSocket("ws://localhost:8080/websocket");
	  socket.onopen = onWebSocketOpened;
	  socket.onmessage = onWebSocketMessage;
	  socket.onclose = onWebSocketClosed;
	} else {
	  alert("Your browser does not support Web Socket.");
	}	
};

function sendWebSocketMessage() {
  if (!window.WebSocket) { return; }
  if (socket.readyState == WebSocket.OPEN) {
	  var input = document.getElementById("input");
	  var message = input.value;
    socket.send(message);
  } else {
    alert("The socket is not open.");
  }
};

function closeWebSocket(){
	if (!window.WebSocket) { return; }
	socket.close();
};

</script>
<div id="websocketConsole">
<form>

    <input type="button" value="open" onclick="openWebSocket();" />
    <input type="button" value="close" onclick="closeWebSocket();" />
    <label for="input">input :</label>
    <input id="input" name="input" type="text" />
    <input type="button" value="send" onclick="sendWebSocketMessage();" />
    <label for="io">input / output :</label>
    <textarea id="io"></textarea>

</form>
</div>

</body>
</html>