<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
</head>
<body>

<script>

// randomUUID
function s4() {
  return Math.floor((1 + Math.random()) * 0x10000)
             .toString(16)
             .substring(1);
};

function randomUUID() {
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
         s4() + '-' + s4() + s4() + s4();
};

// cast

var stringConstructor = "".constructor;
var arrayConstructor = [].constructor;
var objectConstructor = {}.constructor;

function cast(rawObj, constructor)
{
    var obj = new constructor();
    for(var i in rawObj){
    	if (rawObj[i] === null){
    		alert(i + " is null");
    		obj[i] = rawObj[i];
    	}
    	else if (rawObj[i] === undefined){
    		alert(i + " is undefined");
    		obj[i] = rawObj[i];
    	}
    	else if (rawObj[i].constructor === stringConstructor){
    		alert(i + " is string");
    		obj[i] = rawObj[i];
    	}
    	else if (rawObj[i].constructor === arrayConstructor){
    		alert(i + " is array");
    		
    		for (var j in rawObj[i]){
    			if (rawObj[i][j] === null){
    				obj[i][j] = rawObj[i][j];
    			}
    			else if (rawObj[i][j] === undefined){
    				obj[i][j] = rawObj[i][j];
    			}
    			else if (rawObj[i][j] === stringConstructor){
    				obj[i][j] = rawObj[i][j];
    			}
    			else if (rawObj[i][j] === arrayConstructor){
    				// TODO extract cast array method to be recursive
    			}
    			else if (rawObj[i][j] === objectConstructor){
    				obj[i][j] = cast(rawObj[i], classAlias[rawObj[i]._class]);
    			}
    		}
    	}
    	else if (rawObj[i].constructor === objectConstructor){
    		alert(i + " is object");
    		obj[i] = cast(rawObj[i], classAlias[rawObj[i]._class]);
    	}
    }
    return obj;
};

// dto
function DTO() {
};

DTO.prototype.getClass = function() {
    return this._class;
}
function BaseWebSocketNotification() {
    this._class = "org.atinject.core.websocket.dto.BaseWebSocketNotification"
};

BaseWebSocketNotification.prototype = new DTO();


function WebSocketResponseException() {
    this._class = "org.atinject.core.websocket.dto.WebSocketResponseException"
};

WebSocketResponseException.prototype = new DTO();


function BaseWebSocketRequest() {
    this._class = "org.atinject.core.websocket.dto.BaseWebSocketRequest"
};

BaseWebSocketRequest.prototype = new DTO();

BaseWebSocketRequest.prototype.getRequestId = function() {
    return this.requestId;
};

BaseWebSocketRequest.prototype.setRequestId = function(requestId) {
    this.requestId = requestId;
    return this;
};


function SessionOpenedNotification() {
    this._class = "org.atinject.api.session.dto.SessionOpenedNotification"
};

SessionOpenedNotification.prototype = new BaseWebSocketNotification();

SessionOpenedNotification.prototype.getSessionId = function() {
    return this.sessionId;
};

SessionOpenedNotification.prototype.setSessionId = function(sessionId) {
    this.sessionId = sessionId;
    return this;
};


function User() {
    this._class = "org.atinject.api.user.dto.User"
};

User.prototype = new DTO();

User.prototype.getId = function() {
    return this.id;
};

User.prototype.setId = function(id) {
    this.id = id;
    return this;
};

User.prototype.getName = function() {
    return this.name;
};

User.prototype.setName = function(name) {
    this.name = name;
    return this;
};

User.prototype.getPassword = function() {
    return this.password;
};

User.prototype.setPassword = function(password) {
    this.password = password;
    return this;
};


function UserAffinityNotification() {
    this._class = "org.atinject.api.user.dto.UserAffinityNotification"
};

UserAffinityNotification.prototype = new BaseWebSocketNotification();

UserAffinityNotification.prototype.getUrl = function() {
    return this.url;
};

UserAffinityNotification.prototype.setUrl = function(url) {
    this.url = url;
    return this;
};


function BaseWebSocketResponse() {
    this._class = "org.atinject.core.websocket.dto.BaseWebSocketResponse"
};

BaseWebSocketResponse.prototype = new DTO();

BaseWebSocketResponse.prototype.getRequestId = function() {
    return this.requestId;
};

BaseWebSocketResponse.prototype.setRequestId = function(requestId) {
    this.requestId = requestId;
    return this;
};

BaseWebSocketResponse.prototype.getException = function() {
    return this.exception;
};

BaseWebSocketResponse.prototype.setException = function(exception) {
    this.exception = exception;
    return this;
};


function GetUserRequest() {
    this._class = "org.atinject.api.user.dto.GetUserRequest"
};

GetUserRequest.prototype = new BaseWebSocketRequest();

GetUserRequest.prototype.getUuid = function() {
    return this.uuid;
};

GetUserRequest.prototype.setUuid = function(uuid) {
    this.uuid = uuid;
    return this;
};


function GetUserResponse() {
    this._class = "org.atinject.api.user.dto.GetUserResponse"
};

GetUserResponse.prototype = new BaseWebSocketResponse();

GetUserResponse.prototype.getUser = function() {
    return this.user;
};

GetUserResponse.prototype.setUser = function(user) {
    this.user = user;
    return this;
};


var classAlias = new Array();
classAlias["org.atinject.core.dto.DTO"] = DTO;
classAlias["org.atinject.core.websocket.dto.BaseWebSocketNotification"] = BaseWebSocketNotification;
classAlias["org.atinject.core.websocket.dto.WebSocketResponseException"] = WebSocketResponseException;
classAlias["org.atinject.core.websocket.dto.BaseWebSocketRequest"] = BaseWebSocketRequest;
classAlias["org.atinject.api.session.dto.SessionOpenedNotification"] = SessionOpenedNotification;
classAlias["org.atinject.api.user.dto.User"] = User;
classAlias["org.atinject.api.user.dto.UserAffinityNotification"] = UserAffinityNotification;
classAlias["org.atinject.core.websocket.dto.BaseWebSocketResponse"] = BaseWebSocketResponse;
classAlias["org.atinject.api.user.dto.GetUserRequest"] = GetUserRequest;
classAlias["org.atinject.api.user.dto.GetUserResponse"] = GetUserResponse;


// event test

/* function onGetUserResponseEvent(getUserResponseEvent){
	
};

addEventListener("GetUserResponseEvent", onGetUserResponseEvent, false);

var event = document.createEvent("GetUserResponseEvent");
  event.initEvent("GetUserResponseEvent", true, true);
  event.customData = new GetUserResponse();
  window.dispatchEvent(event);
 */
 
 // window event listener is working -----------------------------

 function UserService(){
 };
 
 UserService.prototype.onGetUserResponse = function(getUserResponse){
	 alert(getUserResponse.getClass());
 }
var userService = new UserService();
 
//add an appropriate event listener
 window.addEventListener("onGetUserResponse", function(e){userService.onGetUserResponse(e.detail);});

 // create and dispatch the event
 var event = new CustomEvent("onGetUserResponse", {detail:new GetUserResponse()});
 window.dispatchEvent(event);
 
// test
/*
var getUserResponse = new GetUserResponse();
getUserResponse.setRequestId("abc");
getUserResponse.setException(new WebSocketResponseException());
var getUserResponseString = JSON.stringify(getUserResponse);
alert(getUserResponseString);

var getUserResponseRawObject = JSON.parse(getUserResponseString);
//alert(getUserResponseRawObject.requestId);
var getUserResponseObject = cast(getUserResponseRawObject, classAlias[getUserResponseRawObject._class]);
alert(getUserResponseObject.getRequestId());
alert(getUserResponseObject.getException());
*/
function onWebSocketOpened(event){
	var io = document.getElementById("io");
    io.value = io.value + "Web Socket opened!";
};

function onWebSocketMessage(event){
	var io = document.getElementById("io");
    io.value = io.value + "\n" + event.data
};

function onWebSocketClosed(event){
	var io = document.getElementById('io');
    io.value = io.value + "Web Socket closed";
};

var socket;
function openWebSocket(){
	if (!window.WebSocket) {
	  window.WebSocket = window.MozWebSocket;
	}
	if (window.WebSocket) {
	  socket = new WebSocket("ws://localhost:8080/websocket");
	  socket.onopen = onWebSocketOpened;
	  socket.onmessage = onWebSocketMessage;
	  socket.onclose = onWebSocketClosed;
	} else {
	  alert("Your browser does not support Web Socket.");
	}	
};

function sendWebSocketMessage() {
  if (!window.WebSocket) { return; }
  if (socket.readyState == WebSocket.OPEN) {
	  var input = document.getElementById("input");
	  var message = input.value;
    socket.send(message);
  } else {
    alert("The socket is not open.");
  }
};

function closeWebSocket(){
	if (!window.WebSocket) { return; }
	socket.close();
};

</script>
<div id="websocketConsole">
<form>

    <input type="button" value="open" onclick="openWebSocket();" />
    <input type="button" value="close" onclick="closeWebSocket();" />
    <label for="input">input :</label>
    <input id="input" name="input" type="text" />
    <input type="button" value="send" onclick="sendWebSocketMessage();" />
    <label for="io">input / output :</label>
    <textarea id="io"></textarea>

</form>
</div>

</body>
</html>